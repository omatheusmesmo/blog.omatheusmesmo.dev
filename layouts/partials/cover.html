{{- with .cxt }}
{{- if (and .Params.cover.image (not $.isHidden)) }}
{{- /* Detecção robusta do primeiro post para LCP */ -}}
{{- $isFirst := false }}
{{- if and $.IsHome (isset $ "Index") }}
    {{- if eq $.Index 0 }}
        {{- $isFirst = true }}
    {{- end }}
{{- end }}

{{- $isLCP := or $.IsSingle $isFirst -}}
{{- $fetchPriority := cond $isLCP "high" "auto" -}}
{{- $loading := cond $isLCP "eager" "lazy" -}}

<figure class="entry-cover">
    {{- $alt := (.Params.cover.alt | default .Params.cover.caption | plainify) }}
    
    {{/* Busca a imagem usando um seletor mais flexivel */}}
    {{- $cover := (.Resources.ByType "image").GetMatch (printf "*%s*" .Params.cover.image) }}
    {{- if not $cover }}
        {{- $cover = (resources.ByType "image").GetMatch (printf "*%s*" .Params.cover.image) }}
    {{- end }}

    {{- if $cover -}}
        {{- if eq $cover.MediaType.SubType "svg" -}}
            <img loading="{{ $loading }}" {{ if (eq $fetchPriority "high") }}fetchpriority="high"{{ end }}
                 src="{{ $cover.RelPermalink }}" decoding="async" alt="{{ $alt }}">
        {{- else -}}
            {{/* Otimizacao WebP com srcset responsivo */}}
            {{- $small := $cover.Resize "480x webp q75" -}}
            {{- $medium := $cover.Resize "720x webp q75" -}}
            {{- $large := $cover.Resize "1080x webp q80" -}}

            <img loading="{{ $loading }}"
                 {{ if (eq $fetchPriority "high") }}fetchpriority="high"{{ end }}
                 srcset="{{ $small.RelPermalink }} 480w, {{ $medium.RelPermalink }} 720w, {{ $large.RelPermalink }} 1080w"
                 src="{{ $large.RelPermalink }}"
                 sizes="(max-width: 768px) 100vw, 720px"
                 width="{{ $cover.Width }}" height="{{ $cover.Height }}"
                 decoding="async"
                 {{/* Mantemos o aspect-ratio para zerar o CLS sem forçar largura 100% */}}
                 style="aspect-ratio: {{ $cover.Width }} / {{ $cover.Height }}; height: auto; max-width: 100%;"
                 alt="{{ $alt }}">
        {{- end -}}
    {{- else -}}
        {{/* Fallback para quando o Hugo nao consegue processar a imagem (evita 404) */}}
        {{- $src := .Params.cover.image -}}
        {{- if .Params.cover.relative -}}
            {{- $src = (path.Join .RelPermalink .Params.cover.image) | relURL -}}
        {{- else -}}
            {{- $src = $src | relURL -}}
        {{- end }}
        <img loading="{{ $loading }}" src="{{ $src }}" alt="{{ $alt }}">
    {{- end }}

    {{- if $.IsSingle }}
        {{ with .Params.cover.caption -}}
            <figcaption>{{ . | markdownify }}</figcaption>
        {{- end }}
    {{- end -}}
</figure>
{{- end }}
{{- end -}}

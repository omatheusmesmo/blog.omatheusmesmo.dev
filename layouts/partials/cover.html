{{- with .cxt }}
{{- if (and .Params.cover.image (not $.isHidden)) }}
{{- $isFirst := false }}
{{- if and $.IsHome (isset $ "Index") }}
    {{- if eq $.Index 0 }}
        {{- $isFirst = true }}
    {{- end }}
{{- end }}
{{- $fetchPriority := cond (or $.IsSingle $isFirst) "high" "auto" }}
<figure class="entry-cover">
    {{- $loading := cond (or $.IsSingle $isFirst) "eager" "lazy" }}
    {{- $alt := (.Params.cover.alt | default .Params.cover.caption | plainify) }}
    
    {{/* Busca a imagem no Page Bundle ou nos Assets */}}
    {{- $pageBundleCover := (.Resources.ByType "image").GetMatch (printf "*%s*" (.Params.cover.image)) }}
    {{- $globalResourcesCover := (resources.ByType "image").GetMatch (printf "*%s*" (.Params.cover.image)) }}
    {{- $cover := (or $pageBundleCover $globalResourcesCover)}}

    {{- if $cover -}}
        {{- if eq $cover.MediaType.SubType "svg" -}}
            {{/* SVG não tem Width/Height acessíveis no Hugo nem Resize */}}
            <img loading="{{ $loading }}"
                 {{ if (eq $fetchPriority "high") }}fetchpriority="high"{{ end }}
                 src="{{ $cover.RelPermalink }}"
                 decoding="async"
                 alt="{{ $alt }}">
        {{- else -}}
            {{/* Processamento para imagens Raster (PNG, JPG, WebP) */}}
            {{- $width := $cover.Width -}}
            {{- $height := $cover.Height -}}
            {{- $small := $cover.Resize "720x webp" -}}
            {{- $large := $cover.Resize (printf "%dx%d webp" $width $height) -}}

            <img loading="{{ $loading }}"
                 {{ if (eq $fetchPriority "high") }}fetchpriority="high"{{ end }}
                 srcset="{{ $small.RelPermalink }} 720w, {{ $large.RelPermalink }} {{ $width }}w"
                 src="{{ $large.RelPermalink }}"
                 sizes="(min-width: 768px) 720px, 100vw"
                 width="{{ $width }}" height="{{ $height }}"
                 decoding="async"
                 alt="{{ $alt }}">
        {{- end -}}
    {{- else -}}
        {{/* Fallback para imagens externas ou caminhos manuais */}}
        {{- $imgdl := (.Params.cover.image) | absURL }}
        <img loading="{{ $loading }}" {{ if (eq $fetchPriority "high") }}fetchpriority="high"{{ end }} src="{{ $imgdl }}" alt="{{ $alt }}">
    {{- end }}

    {{- if $.IsSingle }}
        {{ with .Params.cover.caption -}}
            <figcaption>{{ . | markdownify }}</figcaption>
        {{- end }}
    {{- end -}}
</figure>
{{- end }}
{{- end -}}

{{- with .cxt }}
{{- if (and .Params.cover.image (not $.isHidden)) }}
{{- /* Se for a página do post (Single), NUNCA é lazy. Se for a Home, tentamos detectar o primeiro */ -}}
{{- $isFirst := false }}
{{- if and $.IsHome (isset $ "Index") }}
    {{- if eq $.Index 0 }}
        {{- $isFirst = true }}
    {{- end }}
{{- end }}

{{- $isLCP := or $.IsSingle $isFirst -}}
{{- $fetchPriority := cond $isLCP "high" "auto" -}}
{{- $loading := cond $isLCP "eager" "lazy" -}}

<figure class="entry-cover">
    {{- $alt := (.Params.cover.alt | default .Params.cover.caption | plainify) }}
    {{- $pageBundleCover := (.Resources.ByType "image").GetMatch (printf "*%s*" (.Params.cover.image)) }}
    {{- $globalResourcesCover := (resources.ByType "image").GetMatch (printf "*%s*" (.Params.cover.image)) }}
    {{- $cover := (or $pageBundleCover $globalResourcesCover)}}

    {{- if $cover -}}
        {{- if eq $cover.MediaType.SubType "svg" -}}
            <img loading="{{ $loading }}" {{ if (eq $fetchPriority "high") }}fetchpriority="high"{{ end }}
                 src="{{ $cover.RelPermalink }}" decoding="async" alt="{{ $alt }}">
        {{- else -}}
            {{- $small := $cover.Resize "480x webp q75" -}}
            {{- $medium := $cover.Resize "720x webp q75" -}}
            {{- $large := $cover.Resize "1080x webp q80" -}}

            <img loading="{{ $loading }}"
                 {{ if (eq $fetchPriority "high") }}fetchpriority="high"{{ end }}
                 srcset="{{ $small.RelPermalink }} 480w, {{ $medium.RelPermalink }} 720w, {{ $large.RelPermalink }} 1080w"
                 src="{{ $large.RelPermalink }}"
                 sizes="(max-width: 768px) 100vw, 720px"
                 width="{{ $cover.Width }}" height="{{ $cover.Height }}"
                 decoding="async"
                 {{/* O style abaixo e o segredo para matar o CLS de vez */}}
                 style="aspect-ratio: {{ $cover.Width }} / {{ $cover.Height }}; height: auto;"
                 alt="{{ $alt }}">
        {{- end -}}
    {{- else -}}
        {{- $imgdl := (.Params.cover.image) | absURL }}
        <img loading="{{ $loading }}" {{ if (eq $fetchPriority "high") }}fetchpriority="high"{{ end }} 
             src="{{ $imgdl }}" alt="{{ $alt }}">
    {{- end }}

    {{- if $.IsSingle }}
        {{ with .Params.cover.caption -}}
            <figcaption>{{ . | markdownify }}</figcaption>
        {{- end }}
    {{- end -}}
</figure>
{{- end }}
{{- end -}}
